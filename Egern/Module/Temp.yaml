#!name=YouTube 修复版 (Ads+TransFix)
#!desc=修正翻译报错：开启 Binary 模式支持 Protobuf 字幕流，解决点击翻译时的加载错误。
#!author=融合 Maasea + VirgilClyne (Fix: Gemini)
#!arguments=屏蔽上传按钮:true,屏蔽选段按钮:true,屏蔽Shorts按钮:false,启用调试模式:false
#!整理时间：2026.02.14

############################
# 1. 阻断 QUIC/UDP (强制 TCP)
############################
[Rule]
AND,((DOMAIN-SUFFIX,googlevideo.com),(PROTOCOL,UDP)),REJECT
AND,((DOMAIN,youtubei.googleapis.com),(PROTOCOL,UDP)),REJECT
AND,((DOMAIN-SUFFIX,ggpht.com),(PROTOCOL,UDP)),REJECT

############################
# 2. 阻断广告/跟踪域名
############################
DOMAIN, ad.youtube.com, REJECT
DOMAIN, ad-access.youtube.com, REJECT
DOMAIN, analytics.youtube.com, REJECT
DOMAIN, counter.youtube.com, REJECT
DOMAIN, s.youtube.com, REJECT
DOMAIN, doubleclick.net, REJECT

############################
# 3. 辅助去广告 (Map Local)
############################
[Map Local]
^https?:\/\/[\w-]+\.googlevideo\.com\/initplayback.+&oad data-type=text data="" status-code=200
^https?:\/\/youtubei\.googleapis\.com\/youtubei\/v1\/log_event\? data-type=text data="" status-code=200
^https?:\/\/youtubei\.googleapis\.com\/youtubei\/v1\/generate_204\? data-type=text data="" status-code=200
^https?:\/\/www\.youtube\.com\/pagead\/ data-type=text data="" status-code=200
^https?:\/\/www\.youtube\.com\/api\/stats\/ data-type=text data="" status-code=200

############################
# 4. 核心脚本：Maasea (仅去广告)
############################
[Script]
# 使用 Maasea 处理核心 Player/Browse 请求以去除广告
# 关键设置：lyricLang 和 captionLang 设置为 "off"，避免注入冲突
youtube-response = type=http-response, pattern=^https:\/\/youtubei\.googleapis\.com\/youtubei\/v1\/(browse|next|player|search|reel\/reel_watch_sequence|guide|account\/get_setting|get_watch)(\?.*)?$, requires-body=1, max-size=-1, binary-body-mode=1, script-path=https://raw.githubusercontent.com/Maasea/sgmodule/master/Script/Youtube/youtube.response.js, argument="{\"lyricLang\":\"off\",\"captionLang\":\"off\",\"blockUpload\":{{{屏蔽上传按钮}}},\"blockImmersive\":{{{屏蔽选段按钮}}},\"blockShorts\":{{{屏蔽Shorts按钮}}},\"debug\":{{{启用调试模式}}}}"

############################
# 5. 字幕翻译 (关键修正区域)
############################
# 修正说明：
# 1. 移除了 request 脚本（防止请求被篡改导致无限转圈）。
# 2. 保留 response 脚本（负责将返回的字幕加工成双语）。
# 3. [核心修复] 增加了 binary-body-mode=1，支持 Protobuf 格式。

# 处理官方/外挂字幕
yt-timedtext-official = type=http-response, pattern=^https?:\/\/(www|m)\.youtube\.com\/api\/timedtext\?.*subtype=(Official|External), script-path=https://kelee.one/Resource/Script/YouTube/YouTube_Composite_Subtitles_response.js, requires-body=true, binary-body-mode=1

# 处理自动生成的机器翻译字幕 (点击"翻译"时触发此接口)
yt-timedtext-translate = type=http-response, pattern=^https?:\/\/(www|m)\.youtube\.com\/api\/timedtext\?.*subtype=Translate, script-path=https://kelee.one/Resource/Script/YouTube/YouTube_Subtitles_Translate/YouTube_Subtitles_Translate_response.js, requires-body=true, binary-body-mode=1

############################
# 6. YouTube Music (可选)
############################
# 如果不需要 Music 歌词翻译，建议保持注释状态以提升稳定性
# ytmusic-translate-proto = ...

############################
# 7. MITM 全域配置
############################
[MITM]
hostname = %APPEND% *.googlevideo.com, youtubei.googleapis.com, www.youtube.com, m.youtube.com, tv.youtube.com, music.youtube.com
