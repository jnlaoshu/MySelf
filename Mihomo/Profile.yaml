# > ğ¥ğšğ¨ğ¬ğ¡ğ®@Mihomo Optimized for Clash Party
# > Update: 2026.01.18
# > ä¼˜åŒ–ç›®æ ‡ï¼šIPv6ç›´è¿(byr.pt)ã€DNSé˜²æ±¡æŸ“ã€Smart Coreå…¼å®¹æ€§

# --- åŸºç¡€è®¾ç½® ---
mode: rule
ipv6: true               # å¿…é¡»å¼€å¯ï¼Œå¦åˆ™æ— æ³•è®¿é—® IPv6 ç«™ç‚¹
log-level: info
allow-lan: true
mixed-port: 7893
bind-address: '*'
find-process-mode: strict
global-client-fingerprint: chrome

# --- æ€§èƒ½ä¸è¿æ¥ ---
keep-alive-interval: 15
keep-alive-idle: 600
tcp-concurrent: true      # å¼€å¯ TCP å¹¶å‘ï¼ŒåŠ é€Ÿæ¡æ‰‹
unified-delay: true       # ç»Ÿä¸€å»¶è¿Ÿï¼ˆå»é™¤æ¡æ‰‹RTTï¼‰ï¼Œè®© Smart Core æµ‹é€Ÿæ›´å‡†

# --- å¤–éƒ¨èµ„æºæ›´æ–° (ä½¿ç”¨ MetaCubeX å®˜æ–¹æº) ---
profile:
  store-selected: true
  store-fake-ip: true
geo-auto-update: true
geo-update-interval: 24
geodata-mode: true
geox-url:
  geoip: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat"
  geosite: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat"
  mmdb: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/country.mmdb"

# --- å…³é”®ä¼˜åŒ–ï¼šå—…æ¢å™¨ ---
sniffer:
  enable: true
  parse-pure-ip: true
  override-destination: true # æµé‡é‡å®šå‘ï¼Œå¯¹æŠ— DNS åŠ«æŒ
  force-dns-mapping: true
  sniff:
    HTTP: { ports: [80, 8080-8880], override-destination: true }
    TLS: { ports: [443, 8443], override-destination: true }
    QUIC: { ports: [443, 8443], override-destination: true }

# --- Tun æ¨¡å¼ (æ— æ„Ÿä»£ç†) ---
tun:
  enable: true
  stack: mixed           # å…¼å®¹æ€§æœ€å¥½ï¼Œè‹¥æœ‰æ–­æµå¯å°è¯• gvisor
  auto-route: true
  auto-redirect: true
  auto-detect-interface: true
  dns-hijack:
    - "any:53"
    - "tcp://any:53"

# --- DNS è®¾ç½® (æ ¸å¿ƒé‡æ„ï¼šåˆ†æµä¸é˜²æ³„æ¼) ---
dns:
  enable: true
  ipv6: true             # å…è®¸è§£æ IPv6
  listen: :1053
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  prefer-h3: true
  
  # 1. é»˜è®¤ DNS (è§£æå›½å¤–åŸŸåï¼Œä½¿ç”¨åŠ å¯† DNS)
  nameserver:
    - https://8.8.8.8/dns-query
    - https://1.1.1.1/dns-query
  
  # 2. å¤‡ç”¨ DNS
  fallback:
    - https://dns.google/dns-query
    - https://cloudflare-dns.com/dns-query
  
  # 3. æŒ‡å®šåˆ†æµ (å›½å†…åŸŸåèµ°å›½å†… DNSï¼ŒBYR èµ°å›½å†… DNS)
  nameserver-policy:
    "geosite:cn,private": 
      - https://223.5.5.5/dns-query
      - https://1.12.12.12/dns-query
    "byr.pt": # é’ˆå¯¹æ€§ä¿®å¤ï¼šæŒ‡å®š byr.pt ä½¿ç”¨é˜¿é‡Œ DNS è§£æï¼Œç¡®ä¿è·å– AAAA è®°å½•
      - https://223.5.5.5/dns-query
      
  # 4. Fake-IP è¿‡æ»¤ (å…³é”®ï¼šè§£å†³ PT çº¢ç§å’Œ IPv6 è¿æ¥é—®é¢˜)
  fake-ip-filter:
    - "*"
    - "+.lan"
    - "+.local"
    - "stun.*"
    - "time.*.com"
    - "ntp.*.com"
    - "+.msftconnecttest.com"
    - "+.msftncsi.com"
    - "+.byr.pt"         # å…³é”®ï¼šBYR ä¸ä½¿ç”¨è™šæ‹Ÿ IP
    - "+.edu.cn"         # å»ºè®®ï¼šæ•™è‚²ç½‘åŸŸåé€šå¸¸æ”¯æŒ IPv6ï¼Œå»ºè®®ç›´è¿

# --- é”šç‚¹ (Anchors) ---
p: &p 
  type: http
  interval: 86400
  health-check: {enable: true, url: https://www.google.com/generate_204, interval: 300, timeout: 5000}

# ä¼˜åŒ–ç­–ç•¥ç»„å®šä¹‰ï¼šå¢åŠ  "Smart" æ¦‚å¿µå…¼å®¹
pg: &pg {type: select, proxies: [Proxy, é¦™æ¸¯èŠ‚ç‚¹, ç¾å›½èŠ‚ç‚¹, ç‹®åŸèŠ‚ç‚¹, æ—¥æœ¬èŠ‚ç‚¹, å°æ¹¾èŠ‚ç‚¹, éŸ©å›½èŠ‚ç‚¹, DIRECT]}

# ä¼˜åŒ– url-testï¼šClash Party çš„ Smart Core ä¼šæ¥ç®¡è¿™é‡Œï¼Œä½†ä½œä¸ºåå¤‡ä¿ç•™
url-test: &url-test {type: url-test, url: https://www.google.com/generate_204, interval: 300, tolerance: 50, include-all: true}
c: &c {type: http, behavior: classical, format: yaml, interval: 86400}

# --- ä»£ç†æä¾›å•† ---
proxy-providers:
  Subscribe:
    # æ³¨æ„ï¼šåœ¨ Clash Party ä¸­ï¼Œå»ºè®®ç›´æ¥åœ¨ UI å¯¼å…¥è®¢é˜…ï¼Œæ­¤å¤„ä¸ºå…¼å®¹ä½ åŸé…ç½®ä¿ç•™
    url: http://127.0.0.1:38324/download/collection/AllServer 
    path: ./proxy_providers/Subscribe.yaml
    <<: *p

# --- ç­–ç•¥ç»„ (ä¿æŒä½ çš„ä¹ æƒ¯) ---
proxy-groups:
  # ... (èŠ‚ç‚¹åˆ†ç»„ä¿æŒä¸å˜ï¼Œé€»è¾‘æ²¡é—®é¢˜) ...
  - {name: é¦™æ¸¯èŠ‚ç‚¹, <<: *url-test, filter: "(?i)ğŸ‡­ğŸ‡°|é¦™æ¸¯|(\b(HK|Hong|HKG)\b)", icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/HongKong.png}
  - {name: ç¾å›½èŠ‚ç‚¹, <<: *url-test, filter: "(?i)ğŸ‡ºğŸ‡¸|ç¾å›½|æ³¢ç‰¹å…°|è¾¾æ‹‰æ–¯|ä¿„å‹’å†ˆ|å‡¤å‡°åŸ|è´¹åˆ©è’™|ç¡…è°·|æ‹‰æ–¯ç»´åŠ æ–¯|æ´›æ‰çŸ¶|åœ£ä½•å¡|åœ£å…‹æ‹‰æ‹‰|è¥¿é›…å›¾|èŠåŠ å“¥|(\b(US|United States|American|USA|SJC|JFK|LAX|ORD|ATL|DFW|SFO|MIA|SEA|IAD)\b)", icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/UnitedStates.png}
  - {name: ç‹®åŸèŠ‚ç‚¹, <<: *url-test, filter: "(?i)ğŸ‡¸ğŸ‡¬|æ–°åŠ å¡|ç‹®|(\b(SG|Singapore|SIN|XSP)\b)", icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Singapore.png}
  - {name: æ—¥æœ¬èŠ‚ç‚¹, <<: *url-test, filter: "(?i)ğŸ‡¯ğŸ‡µ|æ—¥æœ¬|å·æ—¥|ä¸œäº¬|å¤§é˜ª|æ³‰æ—¥|åŸ¼ç‰|(\b(JP|Japan|NRT|HND|KIX|CTS|FUK)\b)", icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Japan.png}
  - {name: å°æ¹¾èŠ‚ç‚¹, <<: *url-test, filter: "(?i)ğŸ‡¹ğŸ‡¼|ğŸ‡¹ğŸ‡¼|å°æ¹¾|(\b(TW|Tai|TPE|Taiwan|TSA|KHH)\b)", icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Taiwan.png}
  - {name: éŸ©å›½èŠ‚ç‚¹, <<: *url-test, filter: "(?i)ğŸ‡°ğŸ‡·|éŸ©å›½|éŸ“|é¦–å°”|å—æœé²œ|(\b(KR|KOR|Korea|South)\b)", icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Korea.png}
  - {name: Proxy, type: select, include-all: true, proxies: [é¦™æ¸¯èŠ‚ç‚¹, ç¾å›½èŠ‚ç‚¹, ç‹®åŸèŠ‚ç‚¹, æ—¥æœ¬èŠ‚ç‚¹, å°æ¹¾èŠ‚ç‚¹, éŸ©å›½èŠ‚ç‚¹, DIRECT], icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Proxy.png}
  
  # åº”ç”¨åˆ†ç»„
  - {name: AIGC, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/ChatGPT.png}
  - {name: Apple, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Apple.png}
  - {name: Disney, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Disney.png} 
  - {name: Github, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/GitHub.png}  
  - {name: Google, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Google.png}
  - {name: HBO, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/HBO.png}
  - {name: Microsoft, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Microsoft.png}
  - {name: Netflix, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Netflix.png} 
  - {name: OneDrive, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/OneDrive.png}  
  - {name: PayPal, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/PayPal.png}  
  - {name: Spotify, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Spotify.png}
  - {name: Telegram, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Telegram.png}
  - {name: TikTok, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/TikTok.png}   
  - {name: Twitter, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Twitter.png}
  - {name: WeChat, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/WeChat.png }
  - {name: YouTube, <<: *pg, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/YouTube.png}  
  - {name: Final, <<: *pg, include-all: true, icon: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/image/Final.png}

# --- è§„åˆ™é›† ---
rule-providers:
  Reject: {<<: *c, path: ./ruleset/Reject.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Reject.yaml}
  AIGC: {<<: *c, path: ./ruleset/AIGC.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/AIGC.yaml}  
  AppleCN: {<<: *c, path: ./ruleset/AppleCN.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Apple.yaml}
  AppleProxy: {<<: *c, path: ./ruleset/AppleProxy.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/AppleProxy.yaml}
  Disney: {<<: *c, path: ./ruleset/Disney.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Disney.yaml}
  Github: {<<: *c, path: ./ruleset/Github.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Github.yaml}
  Google: {<<: *c, path: ./ruleset/Google.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Google.yaml}
  HBO: {<<: *c, path: ./ruleset/HBO.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/HBO.yaml}
  Microsoft: {<<: *c, path: ./ruleset/Microsoft.yaml, url:https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Microsoft.yaml}
  Netflix: {<<: *c, path: ./ruleset/Netflix.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Netflix.yaml}  
  OneDrive: {<<: *c, path: ./ruleset/OneDrive.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/OneDrive.yaml}
  PayPal: {<<: *c, path: ./ruleset/PayPal.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/PayPal.yaml}
  Spotify: {<<: *c, path: ./ruleset/Spotify.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Spotify.yaml}  
  Telegram: {<<: *c, path: ./ruleset/Telegram.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Telegram.yaml}
  Twitter: {<<: *c, path: ./ruleset/Twitter.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/Twitter.yaml}
  TikTok: {<<: *c, path: ./ruleset/TikTok.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/TikTok.yaml}
  WeChat: {<<: *c, path: ./ruleset/WeChat.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/WeChat.yaml}  
  YouTube: {<<: *c, path: ./ruleset/YouTube.yaml, url: https://raw.githubusercontent.com/jnlaoshu/MySelf/main/Egern/Rule/YouTube.yaml}
  Proxy: {<<: *c, path: ./ruleset/Proxy.yaml, url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Proxy/Proxy_Classical_No_Resolve.yaml}  
  Direct: {<<: *c, path: ./ruleset/Direct.yaml, url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Direct/Direct.yaml}
  Lan: {<<: *c, path: ./ruleset/Lan.yaml, url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan.yaml}  
  China: {<<: *c, path: ./ruleset/China.yaml, url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/ChinaMax/ChinaMax_Classical.yaml}

# --- è§„åˆ™é€»è¾‘ ---
rules: 
  - RULE-SET,Reject,REJECT 
  # ä¼˜å…ˆå¤„ç† BYR ç­‰ PT ç«™ç‚¹ï¼Œç¡®ä¿èµ°ç›´è¿ä¸”ä¸èµ° FakeIP
  - DOMAIN-SUFFIX,byr.pt,DIRECT
  - DOMAIN-SUFFIX,edu.cn,DIRECT

  # åº”ç”¨åˆ†æµ
  - RULE-SET,AIGC,AIGC
  - RULE-SET,AppleCN,DIRECT
  - RULE-SET,AppleProxy,Proxy
  - RULE-SET,Disney,Disney  
  - RULE-SET,Github,Github
  - RULE-SET,Google,Google
  - RULE-SET,HBO,HBO
  - RULE-SET,Microsoft,Microsoft
  - RULE-SET,Netflix,Netflix  
  - RULE-SET,OneDrive,OneDrive
  - RULE-SET,PayPal,PayPal   
  - RULE-SET,Spotify,Spotify
  - RULE-SET,Telegram,Telegram
  - RULE-SET,Twitter,Twitter
  - RULE-SET,TikTok,TikTok
  - RULE-SET,WeChat,WeChat
  - RULE-SET,YouTube,YouTube
  - RULE-SET,Proxy,Proxy  
  - RULE-SET,Direct,DIRECT    
  - RULE-SET,Lan,DIRECT
  
  # å…œåº•è§„åˆ™ (ä½¿ç”¨ GeoSite CNï¼Œé€Ÿåº¦æ¯” IP è§„åˆ™å¿«)
  - GEOSITE,CN,DIRECT
  - RULE-SET,China,DIRECT  
  - GEOIP,CN,DIRECT
  - MATCH,Final
